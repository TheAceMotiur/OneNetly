# ─────────────────────────────────────────────────────────────────────────────
# OneNetly – CloudPanel Nginx Configuration (No .php Extensions)
# ─────────────────────────────────────────────────────────────────────────────
#
# Copy this into CloudPanel → Vhost Editor inside the server {} block
#
# ─────────────────────────────────────────────────────────────────────────────

# Path-based download URLs: /download/ID -> /download.php?id=ID
location ~ ^/download/([a-zA-Z0-9]+)$ {
    rewrite ^/download/(.*)$ /download.php?id=$1 last;
}

# Path-based stream URLs: /stream/ID -> /stream.php?id=ID
location ~ ^/stream/([a-zA-Z0-9]+)$ {
    rewrite ^/stream/(.*)$ /stream.php?id=$1 last;
}

location / {
    try_files $uri $uri/ @extensionless-php;
}

# Handle extensionless PHP URLs
location @extensionless-php {
    rewrite ^(.*)$ $1.php last;
}

# Block direct web access to the database folder (SQL migration files)
location ^~ /database/ {
    deny all;
    return 403;
}

# Block direct access to sensitive PHP files
location ~* ^/(config|drive_api|configuration|database)\.php$ {
    deny all;
    return 403;
}

# Increase client body size limit for large file uploads (5 GB)
client_max_body_size 5200M;

# Increase all timeouts to 2 hours for very large file uploads
proxy_read_timeout    7200;
proxy_connect_timeout 7200;
proxy_send_timeout    7200;
fastcgi_read_timeout  7200;
fastcgi_send_timeout  7200;
fastcgi_connect_timeout 7200;

# IMPORTANT: Make sure your PHP location block includes:
# location ~ \.php$ {
#     try_files $uri =404;
#     fastcgi_pass   127.0.0.1:9000;  # or your PHP-FPM socket
#     fastcgi_index  index.php;
#     fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
#     include        fastcgi_params;
# }
